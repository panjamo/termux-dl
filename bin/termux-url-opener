#!/bin/bash
clear
# root folder PC
# rootfolderVideo="/d/temp/script/"
# rootfolderAudio="/d/temp/script/"

# root folder termux
storage='/data/data/com.termux/files/home/storage/'
rootfolderVideo="${storage}movies/"
rootfolderAudio="${storage}music/"

# options
audio="--ignore-config -f \'bestaudio[ext=m4a]\' -i --no-check-certificate --embed-thumbnail --add-metadata"
video="--ignore-config -f \'bestvideo[height<=480]+bestaudio[ext=m4a]/bestvideo+bestaudio/best\' --merge-output-format mp4 -i --no-check-certificate --add-metadata"
videohd="--ignore-config -i --no-check-certificate --add-metadata"
downloadFast=--external-downloader aria2c --external-downloader-args '-c -j 16 -x 16 -s 16 -k 1M'

bold=$(tput bold)
normal=$(tput sgr0)
echo "${bold}JOSCH\'s Downloader${normal}"
echo "> ${1}"

#youtube-dl -F $1

echo $'\nDownload as an [A]udio or [P]laylist or [V]ideo or [H]D Video file ? (A/V/H/E)'

read -p "> " -n 1 -r
echo $''
if [[ $REPLY =~ ^[Aa]$ ]]; then
	echo "Downloading audio file..."
	cd $rootfolderAudio
	pwd
	ls -1 -d */ | cat -b
	echo $'\nSelect folder ? (any other character=new folder)'
	read -p "> " -n 2 -r
	echo $''
	folder="$(ls -1 -d */ | sed -n ${REPLY}p 2> /dev/null)"
	if [[ -z "${folder}" ]]; then
		echo $'\nNew folder name ?'
		read -p "> " -r
		echo $''
		mkdir "$REPLY"
    	folder="${REPLY}/"
	fi
	youtube-dl --output "${rootfolderAudio}${folder}%(title)s.%(ext)s" $audio ${downloadFast} $1 | tee ~/youtube-dl.log
	#termux-open "${rootfolderAudio}${folder}"
elif [[ $REPLY =~ ^[Pp]$ ]]; then
	echo "Downloading audio playlist..."
	youtube-dl --output "${rootfolderAudio}%(playlist)s/%(playlist_index)s - %(title)s.%(ext)s" $audio $1 | tee ~/youtube-dl.log
elif [[ $REPLY =~ ^[Vv]$ ]]; then
	echo "Downloading video..."
	youtube-dl --output "${rootfolderVideo}%(extractor_key)s/%(uploader)s-%(title)s.%(ext)s" $video ${downloadFast} $1 tee ~/youtube-dl.log
elif [[ $REPLY =~ ^[Hh]$ ]]; then
	echo "Downloading video..."
	youtube-dl --output "${rootfolderVideo}%(extractor_key)s/%(uploader)s-%(title)s.%(ext)s" $videohd ${downloadFast} $1 | tee ~/youtube-dl.log
else
	echo "Exiting..."
fi

filename=$(cat ~/youtube-dl.log | grep "\[ffmpeg\] Correcting container in " | sed "s/^\[ffmpeg\] Correcting container in //")
echo $filename
read -p "> " -n 1 -r

termux-notification --title "Download ready..." --content "Completed: $folder$1"
